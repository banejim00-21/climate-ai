<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate V5 ULTIMATE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Rajdhani', sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); color: #fff; min-height: 100vh; padding: 1rem; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(255,0,255,0.1)); border: 2px solid rgba(0,255,255,0.3); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 0 30px rgba(0,255,255,0.2); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 900; background: linear-gradient(90deg, #0ff, #f0f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; letter-spacing: 3px; }
        .badges { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .badge { padding: 0.4rem 1rem; background: linear-gradient(135deg, rgba(0,255,255,0.2), rgba(255,0,255,0.2)); border: 1px solid rgba(0,255,255,0.4); border-radius: 15px; font-size: 0.8rem; font-weight: 700; }
        .status { display: flex; gap: 1rem; }
        .status-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.3); border-radius: 20px; font-family: 'Orbitron', monospace; font-size: 0.85rem; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #0f0; box-shadow: 0 0 10px #0f0; animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .dot.off { background: #f00; box-shadow: 0 0 10px #f00; animation: none; }
        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
        .card { background: linear-gradient(135deg, rgba(26,26,46,0.9), rgba(26,26,46,0.7)); border: 2px solid rgba(0,255,255,0.3); border-radius: 15px; padding: 1.5rem; transition: all 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 0 30px rgba(0,255,255,0.3); border-color: rgba(0,255,255,0.6); }
        .card-title { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #0ff; margin-bottom: 1rem; letter-spacing: 2px; }
        .metric-value { font-family: 'Orbitron', monospace; font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #0ff, #f0f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0.5rem 0; }
        .metric-sub { font-size: 0.85rem; color: #8892b0; margin-top: 0.5rem; }
        .ai-badge { display: inline-block; padding: 0.4rem 1rem; background: linear-gradient(135deg, #f0f, #0ff); border-radius: 15px; font-size: 0.75rem; font-weight: 700; color: #000; margin-top: 0.5rem; }
        .pid-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; margin-top: 1rem; }
        .pid-item { text-align: center; padding: 0.8rem; background: rgba(0,255,255,0.05); border-radius: 8px; border: 1px solid rgba(0,255,255,0.2); }
        .pid-label { font-size: 0.65rem; color: #8892b0; text-transform: uppercase; margin-bottom: 0.3rem; }
        .pid-value { font-family: 'Orbitron', monospace; font-size: 1.3rem; color: #0ff; }
        .relay-grid { grid-column: span 12; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .relay-card { background: rgba(26,26,46,0.5); border: 2px solid rgba(0,255,255,0.3); border-radius: 12px; padding: 1.2rem; text-align: center; cursor: pointer; transition: all 0.3s; }
        .relay-card:hover { transform: translateY(-3px); border-color: #0ff; }
        .relay-card.active { border-color: #0f0; background: linear-gradient(135deg, rgba(0,255,0,0.15), rgba(26,26,46,0.5)); box-shadow: 0 0 20px rgba(0,255,0,0.3); }
        .relay-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .relay-name { font-family: 'Orbitron', sans-serif; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem; }
        .relay-status { padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
        .relay-status.on { background: rgba(0,255,0,0.2); color: #0f0; border: 1px solid #0f0; }
        .relay-status.off { background: rgba(255,255,255,0.05); color: #8892b0; border: 1px solid #8892b0; }
        .window-control { grid-column: span 12; }
        .window-slider { width: 100%; height: 60px; background: #1a1a2e; border-radius: 30px; border: 2px solid rgba(0,255,255,0.3); overflow: hidden; margin: 1rem 0; position: relative; }
        .window-fill { height: 100%; background: linear-gradient(90deg, #0ff, #f0f); transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 1.5rem; font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 900; }
        .window-buttons { display: flex; gap: 0.8rem; justify-content: center; }
        .btn { padding: 0.8rem 1.5rem; border: 2px solid rgba(0,255,255,0.3); border-radius: 10px; background: rgba(26,26,46,0.8); color: #fff; font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; transition: all 0.3s; }
        .btn:hover { border-color: #0ff; box-shadow: 0 0 20px rgba(0,255,255,0.5); transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .mode-selector { grid-column: span 12; display: flex; gap: 0.8rem; flex-wrap: wrap; }
        .mode-btn { flex: 1; min-width: 120px; padding: 1.2rem; border: 2px solid rgba(0,255,255,0.3); border-radius: 12px; background: rgba(26,26,46,0.5); color: #fff; font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; cursor: pointer; transition: all 0.3s; text-align: center; }
        .mode-btn:hover { border-color: #0ff; transform: translateY(-2px); }
        .mode-btn.active { background: linear-gradient(135deg, #0ff, #f0f); border-color: transparent; color: #000; box-shadow: 0 0 25px rgba(0,255,255,0.5); }
        .chart-container { grid-column: span 6; height: 350px; }
        .stats-grid { grid-column: span 12; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .stat-box { background: rgba(26,26,46,0.5); border: 2px solid rgba(0,255,255,0.3); border-radius: 12px; padding: 1.2rem; text-align: center; }
        .stat-value { font-family: 'Orbitron', monospace; font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, #0ff, #ff0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0.5rem 0; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; color: #8892b0; }
        .control-input { width: 100%; padding: 0.8rem; background: rgba(0,0,0,0.3); border: 2px solid rgba(0,255,255,0.3); border-radius: 8px; color: #fff; font-family: 'Orbitron', monospace; font-size: 1rem; margin-top: 0.5rem; }
        .control-input:focus { outline: none; border-color: #0ff; box-shadow: 0 0 15px rgba(0,255,255,0.3); }
        footer { text-align: center; padding: 2rem; color: #8892b0; margin-top: 2rem; font-size: 0.85rem; }
        @media (max-width: 768px) { h1 { font-size: 1.8rem; } .grid > * { grid-column: span 12 !important; } .relay-grid { grid-template-columns: repeat(2, 1fr); } .mode-selector { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>ğŸ§  Climate V5 ULTIMATE</h1>
                    <div class="badges">
                        <span class="badge">ğŸ§  Red Neuronal</span>
                        <span class="badge">ğŸ“Š Control PID</span>
                        <span class="badge">ğŸ¯ LÃ³gica Difusa</span>
                    </div>
                </div>
                <div class="status">
                    <div class="status-item"><div class="dot" id="wifiDot"></div><span id="wifiStatus">WiFi</span></div>
                    <div class="status-item"><div class="dot off" id="mqttDot"></div><span id="mqttStatus">MQTT</span></div>
                </div>
            </div>
        </header>

        <div class="grid">
            <div class="card" style="grid-column: span 3;">
                <div class="card-title">ğŸŒ¡ï¸ Temperatura</div>
                <div class="metric-value"><span id="temp">--</span>Â°C</div>
                <div class="metric-sub">Setpoint: <span id="setpoint">27.0</span>Â°C</div>
                <input type="number" class="control-input" id="tempInput" placeholder="Nuevo setpoint" step="0.5" min="15" max="35">
                <button class="btn" style="width:100%;margin-top:0.5rem" onclick="setThreshold()">Cambiar</button>
            </div>

            <div class="card" style="grid-column: span 3;">
                <div class="card-title">ğŸ§  PredicciÃ³n IA</div>
                <div class="metric-value"><span id="pred">--</span>Â°C</div>
                <div class="ai-badge" id="aiStatus">Aprendiendo...</div>
            </div>

            <div class="card" style="grid-column: span 3;">
                <div class="card-title">ğŸ’§ Humedad</div>
                <div class="metric-value"><span id="hum">--</span>%</div>
            </div>

            <div class="card" style="grid-column: span 3;">
                <div class="card-title">ğŸ‘¤ Presencia</div>
                <div class="metric-value"><span id="presence">â­•</span></div>
                <div class="metric-sub"><span id="dist">--</span> cm</div>
            </div>

            <div class="card" style="grid-column: span 6;">
                <div class="card-title">ğŸ“Š Control PID</div>
                <div class="pid-grid">
                    <div class="pid-item"><div class="pid-label">Output</div><div class="pid-value" id="pidOut">0</div></div>
                    <div class="pid-item"><div class="pid-label">Error</div><div class="pid-value" id="pidErr">0.0</div></div>
                    <div class="pid-item"><div class="pid-label">Kp/Ki/Kd</div><div class="pid-value" id="pidK" style="font-size:0.9rem">5.0/0.5/1.0</div></div>
                </div>
            </div>

            <div class="card" style="grid-column: span 6;">
                <div class="card-title">ğŸ¯ LÃ³gica Difusa</div>
                <div style="margin-top:1rem;font-size:1.05rem;">
                    <div style="margin-bottom:0.8rem;">Fan: <span id="fuzzyFan" style="color:#0ff;font-weight:700">--</span>%</div>
                    <div style="margin-bottom:0.8rem;">Ventana: <span id="fuzzyWin" style="color:#f0f;font-weight:700">--</span>%</div>
                    <div>Estado: <span id="fuzzyState" style="color:#0f0;font-weight:700">Normal</span></div>
                </div>
            </div>

            <div class="card relay-grid">
                <div class="relay-card" onclick="toggleRelay(1)">
                    <div class="relay-icon">ğŸŒ€</div>
                    <div class="relay-name">Ventilador</div>
                    <div class="relay-status off" id="r1">OFF</div>
                    <div style="margin-top:0.5rem;font-size:0.75rem;color:#8892b0">PWM: <span id="pwm">0</span></div>
                </div>
                <div class="relay-card" onclick="toggleRelay(2)">
                    <div class="relay-icon">ğŸ’¨</div>
                    <div class="relay-name">Motor</div>
                    <div class="relay-status off" id="r2">OFF</div>
                </div>
                <div class="relay-card" onclick="toggleRelay(3)">
                    <div class="relay-icon">ğŸ’¡</div>
                    <div class="relay-name">Luz</div>
                    <div class="relay-status off" id="r3">OFF</div>
                </div>
                <div class="relay-card" onclick="toggleRelay(4)">
                    <div class="relay-icon">âš™ï¸</div>
                    <div class="relay-name">Reserva</div>
                    <div class="relay-status off" id="r4">OFF</div>
                </div>
            </div>

            <div class="card window-control">
                <div class="card-title">ğŸªŸ Control de Ventana</div>
                <div class="window-slider">
                    <div class="window-fill" id="windowFill" style="width: 0%">0%</div>
                </div>
                <div class="window-buttons">
                    <button class="btn" onclick="setWindow(0)">CERRAR</button>
                    <button class="btn" onclick="setWindow(25)">25%</button>
                    <button class="btn" onclick="setWindow(50)">50%</button>
                    <button class="btn" onclick="setWindow(75)">75%</button>
                    <button class="btn" onclick="setWindow(100)">ABRIR</button>
                </div>
            </div>

            <div class="mode-selector">
                <button class="mode-btn active" onclick="setMode('FUZZY-PID')">ğŸ¯ FUZZY-PID</button>
                <button class="mode-btn" onclick="setMode('PID')">ğŸ“Š PID</button>
                <button class="mode-btn" onclick="setMode('FUZZY')">ğŸ¯ FUZZY</button>
                <button class="mode-btn" onclick="setMode('AI')">ğŸ§  AI</button>
                <button class="mode-btn" onclick="setMode('AUTO')">ğŸ¤– AUTO</button>
                <button class="mode-btn" onclick="setMode('SMART')">ğŸ’¡ SMART</button>
            </div>

            <div class="card chart-container">
                <div class="card-title">ğŸ“Š Temperatura</div>
                <canvas id="tempChart"></canvas>
            </div>
            <div class="card chart-container">
                <div class="card-title">ğŸ“ˆ PID Output</div>
                <canvas id="pidChart"></canvas>
            </div>

            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">Uptime</div><div class="stat-value" id="uptime">0h</div></div>
                <div class="stat-box"><div class="stat-label">Activaciones</div><div class="stat-value" id="activations">0</div></div>
                <div class="stat-box"><div class="stat-label">Ventana</div><div class="stat-value"><span id="windowPos">0</span>%</div></div>
                <div class="stat-box"><div class="stat-label">Modo</div><div class="stat-value" id="currentMode" style="font-size:1.3rem">FUZZY-PID</div></div>
            </div>
        </div>

        <footer>
            <p><strong>Sistema V5.0 ULTIMATE</strong> | Red Neuronal + Control PID + LÃ³gica Difusa</p>
            <p style="margin-top:0.5rem;opacity:0.7">ESP32 | DHT11 | HC-SR04 | CloudAMQP | 4 RelÃ©s | Motor Paso a Paso</p>
        </footer>
    </div>

    <script>
        let espIP = '10.224.159.85';  // âš ï¸ CAMBIAR POR TU IP
        
        const mqttConfig = {
            broker: 'wss://perro.lmq.cloudamqp.com:443/mqtt',
            username: 'fqzxnqhg:fqzxnqhg',
            password: 'fz6xwqLm6bjr4YjQt_wR-oujymOZfcgA',
            topic: 'clima/leviatanes'
        };

        let mqttClient = null;
        let tempChart, pidChartObj;
        let tempData = [], pidData = [], timeLabels = [];

        window.onload = function() {
            console.log('ğŸš€ Dashboard V5 ULTIMATE iniciando...');
            initCharts();
            generateInitialData();
            connectMQTT();
            startLocalPolling();
        };

        function connectMQTT() {
            try {
                mqttClient = mqtt.connect(mqttConfig.broker, {
                    username: mqttConfig.username,
                    password: mqttConfig.password,
                    clientId: 'Dashboard_' + Math.random().toString(16).substr(2, 8)
                });
                
                mqttClient.on('connect', () => {
                    console.log('âœ… CloudAMQP conectado');
                    document.getElementById('mqttDot').classList.remove('off');
                    document.getElementById('mqttStatus').textContent = 'MQTT: OK';
                    mqttClient.subscribe(mqttConfig.topic + '/data');
                });
                
                mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        updateDashboard(data);
                    } catch (e) {
                        console.error('Error parsing MQTT:', e);
                    }
                });
                
                mqttClient.on('error', (err) => {
                    console.error('MQTT error:', err);
                    document.getElementById('mqttDot').classList.add('off');
                    document.getElementById('mqttStatus').textContent = 'MQTT: Error';
                });
            } catch (error) {
                console.error('MQTT init error:', error);
            }
        }
        
        function sendMQTT(cmd) {
            if (mqttClient && mqttClient.connected) {
                mqttClient.publish(mqttConfig.topic + '/command', JSON.stringify(cmd));
                console.log('ğŸ“¤ MQTT enviado:', cmd);
            } else {
                console.warn('âš ï¸ MQTT offline, usando HTTP');
                sendHTTP(cmd);
            }
        }

        function startLocalPolling() {
            setInterval(fetchLocal, 3000);
            fetchLocal();
        }
        
        async function fetchLocal() {
            try {
                const res = await fetch(`http://${espIP}/data`);
                if (res.ok) {
                    const data = await res.json();
                    updateDashboard(data);
                    document.getElementById('wifiDot').classList.remove('off');
                    document.getElementById('wifiStatus').textContent = 'WiFi: OK';
                }
            } catch (err) {
                document.getElementById('wifiDot').classList.add('off');
                document.getElementById('wifiStatus').textContent = 'WiFi: Error';
            }
        }
        
        async function sendHTTP(cmd) {
            try {
                await fetch(`http://${espIP}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cmd)
                });
                console.log('ğŸ“¤ HTTP enviado:', cmd);
                fetchLocal();
            } catch (err) {
                console.error('HTTP error:', err);
            }
        }

        function updateDashboard(d) {
            document.getElementById('temp').textContent = d.temperature.toFixed(1);
            document.getElementById('hum').textContent = d.humidity.toFixed(1);
            document.getElementById('dist').textContent = d.distance.toFixed(0);
            document.getElementById('presence').textContent = d.presence ? 'âœ…' : 'â­•';
            document.getElementById('setpoint').textContent = d.tempThreshold.toFixed(1);
            
            if (d.predictedTemp) {
                document.getElementById('pred').textContent = d.predictedTemp.toFixed(1);
            }
            if (d.aiActive) {
                document.getElementById('aiStatus').textContent = 'ğŸ§  IA ACTIVA';
                document.getElementById('aiStatus').style.background = 'linear-gradient(135deg, #0f0, #0ff)';
            }
            
            document.getElementById('pidOut').textContent = (d.pidOutput || 0).toFixed(1);
            document.getElementById('pidErr').textContent = (d.pidError || 0).toFixed(2);
            document.getElementById('pidK').textContent = 
                (d.pidKp||5).toFixed(1) + '/' + (d.pidKi||0.5).toFixed(1) + '/' + (d.pidKd||1).toFixed(1);
            
            let fuzzyFan = 0;
            if (d.temperature > d.tempThreshold + 3) fuzzyFan = 100;
            else if (d.temperature > d.tempThreshold + 1) fuzzyFan = 60;
            else if (d.temperature > d.tempThreshold) fuzzyFan = 30;
            
            document.getElementById('fuzzyFan').textContent = fuzzyFan;
            document.getElementById('fuzzyWin').textContent = d.windowPosition || 0;
            
            let fuzzyState = 'Normal';
            if (d.temperature > d.tempThreshold + 2) fuzzyState = 'Caliente';
            else if (d.temperature < d.tempThreshold - 2) fuzzyState = 'FrÃ­o';
            document.getElementById('fuzzyState').textContent = fuzzyState;
            
            updateRelayUI(1, d.relay1);
            updateRelayUI(2, d.relay2);
            updateRelayUI(3, d.relay3);
            updateRelayUI(4, d.relay4);
            
            document.getElementById('pwm').textContent = d.fanPWM || 0;
            
            const wPos = d.windowPosition || 0;
            document.getElementById('windowFill').style.width = wPos + '%';
            document.getElementById('windowFill').textContent = wPos + '%';
            document.getElementById('windowPos').textContent = wPos;
            
            document.getElementById('currentMode').textContent = d.mode || 'FUZZY-PID';
            
            const h = Math.floor(d.uptime / 3600);
            const m = Math.floor((d.uptime % 3600) / 60);
            document.getElementById('uptime').textContent = h + 'h ' + m + 'm';
            document.getElementById('activations').textContent = d.activations || 0;
            
            addDataToCharts(d.temperature, d.pidOutput || 0);
        }
        
        function updateRelayUI(num, state) {
            const card = document.querySelectorAll('.relay-card')[num - 1];
            const status = document.getElementById('r' + num);
            
            if (state) {
                card.classList.add('active');
                status.textContent = 'ON';
                status.classList.remove('off');
                status.classList.add('on');
            } else {
                card.classList.remove('active');
                status.textContent = 'OFF';
                status.classList.remove('on');
                status.classList.add('off');
            }
        }

        function toggleRelay(n) {
            sendMQTT({ ['relay' + n]: true });
        }
        
        function setWindow(pos) {
            sendMQTT({ window: pos });
            console.log('ğŸªŸ Ventana:', pos + '%');
        }
        
        function setMode(m) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            sendMQTT({ mode: m });
            console.log('âš™ï¸ Modo:', m);
        }
        
        function setThreshold() {
            const value = parseFloat(document.getElementById('tempInput').value);
            if (value >= 15 && value <= 35) {
                sendMQTT({ tempThreshold: value });
                console.log('ğŸŒ¡ï¸ Nuevo setpoint:', value + 'Â°C');
                document.getElementById('tempInput').value = '';
            } else {
                alert('Temperatura debe estar entre 15Â°C y 35Â°C');
            }
        }

        function initCharts() {
            const opts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        grid: { color: 'rgba(0,255,255,0.1)' },
                        ticks: { color: '#8892b0' }
                    },
                    x: {
                        grid: { color: 'rgba(0,255,255,0.1)' },
                        ticks: { color: '#8892b0' }
                    }
                }
            };
            
            tempChart = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        data: tempData,
                        borderColor: '#00ffff',
                        backgroundColor: 'rgba(0,255,255,0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: opts
            });
            
            pidChartObj = new Chart(document.getElementById('pidChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        data: pidData,
                        borderColor: '#ff00ff',
                        backgroundColor: 'rgba(255,0,255,0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: opts
            });
        }
        
        function generateInitialData() {
            const now = new Date();
            for (let i = 23; i >= 0; i--) {
                const t = new Date(now - i * 3600000);
                timeLabels.push(t.getHours() + ':00');
                tempData.push(25 + Math.sin(i/4) * 5);
                pidData.push(50 + Math.cos(i/3) * 30);
            }
            updateCharts();
        }
        
        function addDataToCharts(t, p) {
            if (tempData.length >= 24) {
                tempData.shift();
                pidData.shift();
                timeLabels.shift();
            }
            
            const now = new Date();
            timeLabels.push(now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0'));
            tempData.push(t);
            pidData.push(p);
            updateCharts();
        }
        
        function updateCharts() {
            tempChart.data.labels = timeLabels;
            tempChart.data.datasets[0].data = tempData;
            tempChart.update('none');
            
            pidChartObj.data.labels = timeLabels;
            pidChartObj.data.datasets[0].data = pidData;
            pidChartObj.update('none');
        }
    </script>
</body>
</html>
